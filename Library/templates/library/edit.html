{% extends "layout.html" %}

{% block style %}
.primary-container {
  margin: 0 auto;
  max-width: 750px;
  padding: 20px;
  background-color: #f2f2f2;
  border-radius: 5px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  display: flex;
  height: 100%;
  flex-direction: column;
}

* {
    box-sizing: border-box;
  }

  a {
    text-decoration: none;
    color: #379937;
  }

  body {
    margin: 40px;
  }

  .dropdown {
    position: relative;
    display: block;
    font-size: 14px;
    color: #333;

    .dropdown-list {
      padding: 12px;
      background: #fff;
      position: absolute;
      top: 30px;
      left: 2px;
      right: 2px;
      box-shadow: 0 1px 2px 1px rgba(0, 0, 0, .15);
      transform-origin: 50% 0;
      transform: scale(1, 0);
      transition: transform .15s ease-in-out .15s;
      max-height: 66vh;
      overflow-y: scroll;
    }

    .dropdown-option {
      display: block;
      padding: 8px 12px;
      opacity: 0;
      transition: opacity .15s ease-in-out;
    }

    .dropdown-label {
      display: block;
      height: 30px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 6px 12px;
      line-height: 1;
      cursor: pointer;

      &:before {
        content: '▼';
        float: right;
      }
    }

    &.on {
     .dropdown-list {
        transform: scale(1, 1);
        transition-delay: 0s;

        .dropdown-option {
          opacity: 1;
          transition-delay: .2s;
        }
      }

      .dropdown-label:before {
        content: '▲';
      }
    }

    [type="checkbox"] {
      position: relative;
      top: -1px;
      margin-right: 4px;
    }

    :active, :hover, :focus {
      outline: 0;
      outline-offset: 0;
    }
  }
{% endblock style %}

{% block title %}
    <title>Edit</title>
{% endblock title %}

{% block body %}
<div class="primary-container">
  <div class="container-fluid">
      <div class="row d-flex flex-wrap justify-content-center">
          <h2>{{header}}</h2>
          <form method="post" action="{% url 'edit' title=book.title %}" enctype="multipart/form-data">
            {% csrf_token %}
            {{form.errors}}
            {{ form.non_field_errors }}
            <div class="form-group form-inline">
                {{form.title.label}}
                <br/>
                {{form.title}}
            </div>
            <div class="form-group form-inline">
                {{form.authors.label}}
                <br/>
                <div class="dropdown" id="authorsDd" data-control="checkbox-dropdown">
                    <label class="dropdown-label">Select</label>
                    
                    <div class="dropdown-list " style="max-height: 550%; overflow-y: auto;">
                      <a data-toggle="check-all" class="dropdown-option" >
                        Select All
                      </a>

                      {% for author in form.authors %}
                        <div class="dropdown-option d-flex justify-content-between">
                            {{ author }}
                              <a href="{% url 'editAuthor' pk=author.data.value %}">Edit</a>
                        </div>
                      {% endfor %}
                  

                      <a class="dropdown-option" href="{% url 'addAuthor' %}">
                        Add Author
                      </a>
                    </div>
                </div>
            </div>
            <div class="form-group form-inline">
              {{form.tags.label}}
              <br/>
              <div class="dropdown" id="tagsDd" data-control="checkbox-dropdown">
                <label class="dropdown-label">Select</label>
                  
                <div class="dropdown-list " style="max-height: 550%; overflow-y: auto;" input="1d">
                  <a href="#" data-toggle="check-all" class="dropdown-option" >
                    Select All  
                  </a>
                
                  {% for tag in form.tags %}
                    <div class="dropdown-option d-flex justify-content-between">
                        {{ tag }}
                          <a href="{% url 'editTag' pk=tag.data.value %}">Edit</a>
                    </div>
                  {% endfor %}

                  <a class="dropdown-option" href="{% url 'addTag' %}"">
                    Add Tag
                  </a>
                </div>
              </div>
          </div>
          <div class="form-group form-inline">
            {{form.genres.label}}
            <br/>
            <div class="dropdown" id="genresDd" data-control="checkbox-dropdown">
              <label class="dropdown-label">Select</label>
                            
              <div class="dropdown-list" style="max-height: 550%; overflow-y: auto;" input="1d">
                <a href="#" data-toggle="check-all" class="dropdown-option" >
                  Select All 
                </a>
                            
                {% for genre in form.genres %}
                  <div class="dropdown-option d-flex justify-content-between">
                      {{ genre }}
                        <a href="{% url 'editGenre' pk=genre.data.value %}">Edit</a>
                  </div>
                {% endfor %}

                <a class="dropdown-option" href="{% url 'addGenre' %}"">
                  Add Genre
                </a>
              </div>
            </div>            
        </div>
        <div class="form-group">
          {{form.description.label}}
          {{form.description}}
      </div>
      <div class="form-group">
        {{form.coverart.label}}
        {{form.coverart}}
      </div>
      <button type="submit" class="btn btn-info">Save Changes</button>
        </form>
      </div>
  </div>
</div>
{% endblock body %}

{% block script %}
(function($) {
    var CheckboxDropdown = function(el) {
      var _this = this;
      this.isOpen = false;
      this.areAllChecked = false;
      this.$el = $(el);
      this.$label = this.$el.find('.dropdown-label');
      this.$checkAll = this.$el.find('[data-toggle="check-all"]').first();
      this.$inputs = this.$el.find('[type="checkbox"]');

      this.onCheckBox();

      this.$label.on('click', function(e) {
        e.preventDefault();
        _this.toggleOpen();
      });

      this.$checkAll.on('click', function(e) {
        e.preventDefault();
        _this.onCheckAll();
      });

      this.$inputs.on('change', function(e) {
        _this.onCheckBox();
      });
    };

    CheckboxDropdown.prototype.onCheckBox = function() {
      this.updateStatus();
    };

    CheckboxDropdown.prototype.updateStatus = function() {
      var checked = this.$el.find(':checked');

      this.areAllChecked = false;
      this.$checkAll.html('Select All');

      if(checked.length <= 0) {
        this.$label.html('Select an option');
      }
      else if(checked.length === 1) {
        this.$label.html(checked.parent('label').text());
      }
      else if(checked.length === this.$inputs.length) {
        this.$label.html('All Selected');
        this.areAllChecked = true;
        this.$checkAll.html('Unselect All');
      }
      else {
        this.$label.html(checked.length + ' Selected');
      }
    };

    CheckboxDropdown.prototype.onCheckAll = function(checkAll) {
      if(!this.areAllChecked || checkAll) {
        this.areAllChecked = true;
        this.$checkAll.html('Unselect All');
        this.$inputs.prop('checked', true);
      }
      else {
        this.areAllChecked = false;
        this.$checkAll.html('Select All');
        this.$inputs.prop('checked', false);
      }

      this.updateStatus();
    };

    CheckboxDropdown.prototype.toggleOpen = function(forceOpen) {
      var _this = this;

      if(!this.isOpen || forceOpen) {
         this.isOpen = true;
         this.$el.addClass('on');
        $(document).on('click', function(e) {
          if(!$(e.target).closest('[data-control]').length) {
           _this.toggleOpen();
          }
        });
      }
      else {
        this.isOpen = false;
        this.$el.removeClass('on');
        $(document).off('click');
      }
    };

    var checkboxesDropdowns = document.querySelectorAll('[data-control="checkbox-dropdown"]');
    for(var i = 0, length = checkboxesDropdowns.length; i < length; i++) {
      new CheckboxDropdown(checkboxesDropdowns[i]);
    }
  })(jQuery);


  document.addEventListener('DOMContentLoaded', function() {
    const dropdowns = document.getElementsByClassName('dropdown');

    for (let i = 0; i < dropdowns.length; i++) {
      dropdowns[i].addEventListener('click', function() {
        const elementId = this.getAttribute('id');
        for (let i = 0; i < dropdowns.length; i++) {
          const dropdown = dropdowns[i];
          const dropdownId = dropdown.getAttribute('id');

          dropdown.style.zIndex = 'auto';
          dropdown.classList.remove('on')

          if (dropdownId == elementId) {
            dropdown.style.zIndex = '9999';
            dropdown.classList.add('on')
          }
        }
      });
    }
  });
{% endblock script %}
